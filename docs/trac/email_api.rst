.. _trac-email_api:
.. vim: syntax=rst
.. vim: textwidth=72
.. vim: spell spelllang=ru,en

===============
Email интерфейс
===============
Имеется возможность создания и обновления задач посредством посылки
email сообщений в специальном формате. Все сообщения отправляются по
адресу opensan-trac-request@opensan-trac.etegro.local. Обрабатываются
автоматом роботом.

Создание задачи
===============
Действие по-умолчанию при приходе письма — создание нового задания.
Поле *Summary* будет заполнено данными из темы письма, а описание
задание полностью берётся из текстового тела сообщения.

Добавление комментария
======================
Все сообщения оповещения в поле темы имеют формат "XX: Summary", где XX
является идентификатором задачи. Если приходящее письмо имеет в теме
письма "ID: ", то вместо создания нового задания будет добавлен
комментарий к задаче, содержание которого берётся из тела сообщения.

Управление метаинформацией
==========================
При создании задачи
-------------------
В теме сообщения, после того что должно являться полем *Summary*, можно
указать различные выставляемые атрибуты задачи. Например:

  Subject: Bas #?owner=bas&version=0.80 

создаст задачу с *Summary* содержащим “Bas”, владельцем установленным
“bas”, и прикреплённой версией “0.80”.

Обновляя задачу в теме письма
-----------------------------
При обновлении задачи после идентификатора задачи в теме письма можно
указать изменения атрибутов по аналогии как это делалось при создании.
Например:

  Subject: #4?milestone=1.2: Bas 

изменит milestone задачи #4 на “1.2”.

Обновляя задачу в теле письма
-----------------------------
В самом конце тела письма можно добавлять записи (по одной на строку)
вида:

  @FIELD: NEWVALUE

где *FIELD* является изменяемым полем задачи, а *NEWVALUE* его новым
значением. Например:

  @owner : bas
  @type: task

Прикрепления
============
Бинарные прикрепления к письму также прикрепятся и к задаче. В теле
письма на отдельной строчке можно указывать **<ATTNAME>**, где *ATTNAME*
является названием прикреплённого файла. Данная строка преобразуется в
wiki тэг *[attachment:"ATTNAME"]*.

Для отображения (а не просто прикрепления к задаче) изображения
необходимо чтобы прикрепляемый файл имел MIME *Content-Type* вида
**image/***, а *Content-Disposition* равный **inline**. Тогда строка в
теле письма вида **<ATTNAME>** преобразуется в wiki тэг
*[[Image(image)]]*.

Отправка почты на opensan-trac.etegro.local
===========================================
Любой UNIX-like дистрибутив имеет локальный sendmail-совместимый
почтовый сервер. Для настройки Postfix, чтобы он мог отправлять почту на
opensan-track.etegro.local домен, достаточно сделать следующее:

* добавить запись о том, что opensan-trac домен можно relay-ить, в
  main.cf:

  relay_domains = opensan-trac.etegro.local

* добавить запись о том, что необходимо использовать собственные
  транспорты для доступа к доменам, в main.cf:

  transport_maps = hash:/etc/postfix/transport

* собственно, описать эти карты транспортов в /etc/postfix/transport:

  opensan-trac.etegro.local smtp:192.168.10.72

* захэшировать карты транспортов (бинарный формат который использует
  Postfix):

  # postmap /etc/postfix/transport

* обновить конфигурацию Postfix-а:

  # /etc/init.d/postfix reload
